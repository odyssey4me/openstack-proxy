# This file autogenerated by Chef
# Do not edit, changes will be overwritten
<% if not node["custom_template_banner"].nil? %>
<%= node["custom_template_banner"] %>
<% end %>

Listen <%= @public_ip %>:<%= @public_port %>

<VirtualHost <%= @public_ip %>:<%= @public_port %>>
  ServerName <%= @public_name %>

<% if @use_ssl %>
  SSLEngine on
  SSLCertificateFile <%= @cert_file %>
  SSLCertificateKeyFile <%= @key_file %>
  SSLCertificateChainFile <%= @chain_file %>

  SSLVerifyClient optional
  SSLVerifyDepth 10
  SSLProtocol -ALL +SSLv3 +TLSv1
  SSLCipherSuite RC4-SHA:RC4:HIGH:!MD5:!aNULL:!EDH:!ADH:!AESGCM:!AES
  SSLOptions +StdEnvVars +ExportCertData
<% end %>

  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>

  ProxyRequests Off
  ProxyPass / <%= @internal_scheme %>://<%= @internal_ip %>:<%= @internal_port %>/
  ProxyPassReverse / <%= @internal_scheme %>://<%= @internal_ip %>:<%= @internal_port %>/

  AddOutputFilterByType SUBSTITUTE text/html
  AddOutputFilterByType SUBSTITUTE application/json

<% @service_array.each do |svc, svc_props| %>
<% if @use_ssl %>
  Substitute "s|<%= svc_props['internal_scheme'] %>://<%= svc_props['internal_ip'] %>:<%= svc_props['internal_port'] %>|https://<%= svc_props['public_name'] %>:<%= svc_props['public_port'] %>|i"
<% else %>
  Substitute "s|<%= svc_props['internal_scheme'] %>://<%= svc_props['internal_ip'] %>:<%= svc_props['internal_port'] %>|http://<%= svc_props['public_name'] %>:<%= svc_props['public_port'] %>|i"
<% end %>
<% end %>

  ErrorLog <%= @apache_log_dir %>/<%= @error_log_file %>
  LogLevel error
  CustomLog <%= @apache_log_dir %>/<%= @access_log_file %> combined
</VirtualHost>
